# Design: `kanuka secrets ci-init`

## Overview

Add a new command `kanuka secrets ci-init` that sets up GitHub Actions CI integration for an existing kanuka-managed project. This command generates a dedicated CI keypair, registers the CI user, creates a workflow template, and securely displays the private key via TTY.

## Use Case

Primary use case: Existing kanuka projects adding CI integration for the first time.

## Command Flow

```
kanuka secrets ci-init
```

### 1. Pre-flight Checks (Fail Fast)

| Check | Behavior |
|-------|----------|
| Project not initialized | Fail: "Run `kanuka secrets init` first" |
| CI user already exists | Fail: "CI user already exists. Use `kanuka secrets revoke` to remove first" |
| No TTY available | Fail: "This command requires an interactive terminal for security" |
| No git remote | Graceful: Use placeholder `<owner>/<repo>` in instructions |

CI user detection: Check if email `41898282+github-actions[bot]@users.noreply.github.com` is already in project config.

### 2. Key Generation

- Generate RSA keypair in memory (reuse existing `secrets.GenerateRSAKeyPair`)
- No passphrase protection (simpler CI setup)
- Private key never written to disk
- Email identifier: `41898282+github-actions[bot]@users.noreply.github.com` (official GitHub Actions bot)

### 3. Registration

Two-step process:
1. Add CI user to project config (generate new UUID, add email to Users map)
2. Call `workflows.Register` with `RegisterModePubkeyText` to encrypt symmetric key for CI user

Create audit log entry for traceability.

### 4. Workflow File Creation

Create `.github/workflows/kanuka-decrypt.yml`:

```yaml
# Kanuka Secrets - GitHub Actions Integration
# Generated by: kanuka secrets ci-init
# 
# This workflow demonstrates how to decrypt Kanuka-managed secrets in CI.
# Modify the trigger and add your build/deploy steps as needed.

name: Kanuka Secrets Example

on: [pull_request]

jobs:
  example:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      # Set up Kanuka CLI with the private key from GitHub Secrets
      - name: Setup Kanuka
        uses: PolarWolf314/kanuka-actions@v1
        with:
          private-key: ${{ secrets.KANUKA_PRIVATE_KEY }}
      
      # Decrypt all .kanuka files to .env files
      - name: Decrypt secrets
        run: cat "$KANUKA_PRIVATE_KEY_PATH" | kanuka secrets decrypt --private-key-stdin
      
      # Example: source the decrypted secrets and use them
      - name: Use secrets
        run: |
          source .env
          echo "Secrets are now available as environment variables"
          # Add your build/deploy commands here
```

If file already exists: Skip creation with warning message.

### 5. Secure Key Display

#### TTY Access
- Unix: Open `/dev/tty` directly
- Windows: Open `CON` device

#### Display Flow

1. **Brief instructions (before key):**
   ```
   Copy the private key below and save it to GitHub Secrets.
   This key will NOT be shown again.
   
   ═══════════════════════════════════════════════════════════
   ```

2. **Display PEM-encoded private key**

3. **Wait prompt:**
   ```
   ═══════════════════════════════════════════════════════════
   
   Press Enter when you have copied the key...
   ```

4. **Wait for Enter**

5. **Clear screen** (ANSI escape sequences)

6. **Show detailed instructions:**
   ```
   ✓ CI user registered successfully!
   ✓ Workflow template created at .github/workflows/kanuka-decrypt.yml
   
   Next steps:
   
   1. Go to your GitHub repository secrets:
      https://github.com/<owner>/<repo>/settings/secrets/actions
   
   2. Click "New repository secret"
   
   3. Name: KANUKA_PRIVATE_KEY
      Value: (paste the private key you just copied)
   
   4. Click "Add secret"
   
   5. Commit and push the workflow file:
      git add .github/workflows/kanuka-decrypt.yml .kanuka/
      git commit -m "Add Kanuka CI integration"
      git push
   
   The next pull request will automatically decrypt secrets!
   ```

### 6. Error Handling

- Use spinner pattern consistent with other commands
- Full rollback on mid-process errors:
  - Remove CI user from project config if added
  - Delete workflow file if created
  - Remove public key and .kanuka file if created
- Use `defer` pattern with `cleanupNeeded` flag

## File Structure

```
cmd/
  secrets_ci_init.go      # Cobra command definition
  
internal/
  workflows/
    ci_init.go            # Core ci-init workflow logic
  utils/
    tty.go                # TTY utilities (WriteToTTY, ClearScreen, WaitForEnter)

test/
  integration/
    ci_init/
      ci_init_test.go     # Integration tests
```

## Constants

```go
const (
    CIUserEmail = "41898282+github-actions[bot]@users.noreply.github.com"
    WorkflowPath = ".github/workflows/kanuka-decrypt.yml"
)
```

## API

### CIInitOptions

```go
type CIInitOptions struct {
    Verbose bool
    Debug   bool
}
```

### CIInitResult

```go
type CIInitResult struct {
    CIUserUUID       string
    CIUserEmail      string
    WorkflowCreated  bool
    WorkflowPath     string
    PrivateKeyPEM    []byte  // In-memory only, for display
    GitHubRepoURL    string  // Auto-detected or placeholder
}
```

## Security Considerations

1. **Private key never written to disk** - Generated in memory, displayed via TTY, then discarded
2. **TTY bypass** - Writing to /dev/tty or CON ensures key doesn't appear in stdout/stderr logs
3. **Screen clear** - ANSI escape sequences clear terminal after user dismisses
4. **Interactive only** - No --yes flag to prevent accidental key exposure in scripts
5. **No passphrase** - Simplifies CI setup; GitHub Secrets provides the protection layer

## Testing Strategy

Integration tests in `test/integration/ci_init/`:

1. `TestCIInitBasic` - Happy path in initialized project
2. `TestCIInitNotInitialized` - Error when project not initialized
3. `TestCIInitAlreadyConfigured` - Error when CI user already exists
4. `TestCIInitWorkflowExists` - Warning when workflow file exists (skip creation)
5. `TestCIInitNoGitRemote` - Placeholder used when no git remote

Note: TTY display testing will require mocking `/dev/tty` or testing output functions in isolation.

## Out of Scope

- Support for CI providers other than GitHub Actions
- Passphrase-protected CI keys
- Non-interactive mode (--yes flag)
- Multiple CI users per project
